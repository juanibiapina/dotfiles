#!/usr/bin/env bash
#
# Summary: Display a loading screen until neovim is ready
#
# Usage: {cmd}
#
# Shows a full-screen Matrix animation until the nvim socket exists,
# or until the user presses Esc to dismiss.

set -e

SOCKET_PATH=".local/share/nvim/socket"
MAX_WAIT=30  # Maximum seconds to wait

# Start background watcher that will kill tarts when nvim is ready
(
  elapsed=0
  while [ $elapsed -lt $MAX_WAIT ]; do
    if [ -S "$SOCKET_PATH" ]; then
      # Socket exists, nvim is ready - kill tarts to dismiss popup
      pkill -f "tarts matrix" 2>/dev/null || true
      exit 0
    fi
    sleep 0.5
    elapsed=$((elapsed + 1))
  done
  # Timeout reached, dismiss anyway
  pkill -f "tarts matrix" 2>/dev/null || true
) &

# Run tarts (will be killed by background watcher or user keypress)
# -B removes the border, -E closes popup when command exits
tmux display-popup -B -h 100% -w 100% -E "tarts matrix || true"
