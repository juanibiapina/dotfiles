#!/usr/bin/env bash
#
# Summary: Interactive todo manager for the current project
#
# Usage: {cmd} [--add]
#
# Opens a full TUI in a tmux popup for managing todos.
# With --add, opens in capture mode to quickly add a single item.
#
# Keybindings:
#   j/k     - Navigate up/down
#   a       - Add a new todo
#   e       - Edit the selected todo
#   space   - Toggle checkbox (done/not done)
#   d       - Delete the selected todo
#   K       - Move item up
#   J       - Move item down
#   enter   - Paste selected todo into the active pane
#   q/esc   - Quit

set -e

declare -A args="($_DEV_ARGS)"

# Resolve paths
HELPER="${_DEV_ROOT}/lib/todos.sh"
HELPER_ABS="$(cd "$(dirname "$HELPER")" && pwd)/$(basename "$HELPER")"

# Compute section heading
tilde="~"
section="## ${PWD/#$HOME/$tilde}"
short_section="${PWD/#$HOME/$tilde}"

# Write section to a file to avoid quoting issues in fzf bindings
section_file=$(mktemp)
printf '%s' "$section" > "$section_file"

# Capture mode: just add one item and exit
if [ "${args[add]}" = "true" ]; then
  todo=$(gum input --placeholder 'Add a todo...' --width 0) || exit 0
  if [ -n "$todo" ]; then
    bash "$HELPER_ABS" add "$section" "$todo"
    tmux display-message "Added: $todo"
  fi
  rm -f "$section_file"
  exit 0
fi

# Create action scripts in temp dir for safe argument passing
action_dir=$(mktemp -d)
trap "rm -rf '$action_dir' '$section_file'" EXIT

# List command
cat > "$action_dir/list.sh" << 'SCRIPT'
#!/usr/bin/env bash
section=$(cat "$1")
bash "$2" list "$section"
SCRIPT

# Add command
cat > "$action_dir/add.sh" << 'SCRIPT'
#!/usr/bin/env bash
section=$(cat "$1")
todo=$(gum input --placeholder 'Add a todo...' --width 0) || exit 0
[ -n "$todo" ] && bash "$2" add "$section" "$todo"
SCRIPT

# Toggle command
cat > "$action_dir/toggle.sh" << 'SCRIPT'
#!/usr/bin/env bash
section=$(cat "$1")
bash "$2" toggle "$section" "$3"
SCRIPT

# Delete command
cat > "$action_dir/delete.sh" << 'SCRIPT'
#!/usr/bin/env bash
section=$(cat "$1")
bash "$2" delete "$section" "$3"
SCRIPT

# Edit command
cat > "$action_dir/edit.sh" << 'SCRIPT'
#!/usr/bin/env bash
section=$(cat "$1")
line="$3"
# Strip checkbox prefix to get the text
text="${line#- \[ \] }"
text="${text#- \[x\] }"
new=$(gum input --value "$text" --placeholder 'Edit todo...' --width 0) || exit 0
[ -n "$new" ] && bash "$2" edit "$section" "$line" "$new"
SCRIPT

# Move up command
cat > "$action_dir/move-up.sh" << 'SCRIPT'
#!/usr/bin/env bash
section=$(cat "$1")
bash "$2" move-up "$section" "$3"
SCRIPT

# Move down command
cat > "$action_dir/move-down.sh" << 'SCRIPT'
#!/usr/bin/env bash
section=$(cat "$1")
bash "$2" move-down "$section" "$3"
SCRIPT

chmod +x "$action_dir"/*.sh

# fzf binding strings
list_cmd="bash '$action_dir/list.sh' '$section_file' '$HELPER_ABS'"

add_action="execute(bash '$action_dir/add.sh' '$section_file' '$HELPER_ABS')+reload($list_cmd)+last"
toggle_action="execute-silent(bash '$action_dir/toggle.sh' '$section_file' '$HELPER_ABS' {})+reload($list_cmd)"
delete_action="execute-silent(bash '$action_dir/delete.sh' '$section_file' '$HELPER_ABS' {})+reload($list_cmd)"
edit_action="execute(bash '$action_dir/edit.sh' '$section_file' '$HELPER_ABS' {})+reload($list_cmd)"
move_up_action="execute-silent(bash '$action_dir/move-up.sh' '$section_file' '$HELPER_ABS' {})+reload($list_cmd)+up"
move_down_action="execute-silent(bash '$action_dir/move-down.sh' '$section_file' '$HELPER_ABS' {})+reload($list_cmd)+down"
paste_action="become(echo {})"

header="  a:add  e:edit  sp:toggle  d:delete  K/J:reorder  enter:paste  q:quit"

# Launch fzf
selected=$(bash "$action_dir/list.sh" "$section_file" "$HELPER_ABS" | fzf \
  --no-sort \
  --no-input \
  --reverse \
  --no-info \
  --border rounded \
  --border-label " Todos: $short_section " \
  --border-label-pos center \
  --header "$header" \
  --header-first \
  --color "header:dim" \
  --bind "j:down" \
  --bind "k:up" \
  --bind "a:$add_action" \
  --bind "space:$toggle_action" \
  --bind "d:$delete_action" \
  --bind "e:$edit_action" \
  --bind "K:$move_up_action" \
  --bind "J:$move_down_action" \
  --bind "enter:$paste_action" \
  --bind "q:abort" \
  --bind "esc:abort" \
) || true

# If something was selected (enter/paste), send it to tmux
if [ -n "$selected" ]; then
  # Extract just the text (strip checkbox prefix)
  text="${selected#- \[ \] }"
  text="${text#- \[x\] }"
  tmux set-buffer "$text"
  tmux paste-buffer
fi
