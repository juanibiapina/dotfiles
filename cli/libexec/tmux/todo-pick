#!/usr/bin/env bash
#
# Summary: Pick a todo for the current directory and paste it
#
# Usage: {cmd}
#
# Opens an fzf popup listing todos from the current directory's section
# in $NOTES_VAULT/Todos.md. The selected item is pasted into the active pane.

set -e

todo_file="$NOTES_VAULT/Todos.md"

if [ ! -f "$todo_file" ]; then
  tmux display-message "No todos file found"
  exit 0
fi

# Compute section heading: replace $HOME with ~
tilde="~"
section="## ${PWD/#$HOME/$tilde}"

# Extract lines from the matching section (between this ## and next ## or EOF)
# Then filter to non-empty, non-heading lines
items=$(awk -v section="$section" '
  $0 == section { found=1; next }
  found && /^## / { exit }
  found && NF { print }
' "$todo_file")

if [ -z "$items" ]; then
  tmux display-message "No todos for this directory"
  exit 0
fi

# Write items and selection to temp files
itemsfile=$(mktemp)
tmpfile=$(mktemp)
trap "rm -f $itemsfile $tmpfile" EXIT

echo "$items" > "$itemsfile"

tmux display-popup -E -w 80% -h 60% "cat '$itemsfile' | fzf --reverse > '$tmpfile'" || true

if [ -s "$tmpfile" ]; then
  selected=$(cat "$tmpfile")
  if [ -n "$selected" ]; then
    tmux set-buffer "$selected"
    tmux paste-buffer

    # Remove the first occurrence of the selected line from the todo file
    awk -v line="$selected" '!done && $0 == line { done=1; next } { print }' "$todo_file" > "$todo_file.tmp"
    mv "$todo_file.tmp" "$todo_file"
  fi
fi
