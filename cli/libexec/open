#!/usr/bin/env bash
#
# Summary: Opens a project for development in tmux
#
# Usage: {cmd} <project>
#
# Changes into the project directory and opens a tmux session named after
# that project
#
# If a .config/dev-session file exists in the project, it will be used to
# create the tmux session, otherwise a default session is created with an
# editor and a terminal window.

set -e

# Provide completions
if [ "$1" = "--complete" ]; then
  dev list
  exit
fi

project="$1"

# Extract last component for the name
name="${project##*/}"

# Remove characters that can't appear in the tmux session name
name="${name//./-}"

# Check if a session with this name already exists for a different project
session_exists=$(tmux list-sessions 2>/dev/null | grep -q "^$name:" && echo "yes" || echo "no")
if [ "$session_exists" = "yes" ]; then
  # Get the project stored in the session's environment variable
  existing_project=$(tmux show-environment -t "$name" DEV_PROJECT 2>/dev/null | sed 's/^DEV_PROJECT=//' || echo "")

  # If the existing session is for a different project, find a unique name
  if [ "$existing_project" != "$project" ]; then
    base_name="$name"
    suffix=2
    while tmux list-sessions 2>/dev/null | grep -q "^$name:"; do
      name="${base_name}-${suffix}"
      suffix=$((suffix + 1))
    done
  fi
fi

# Include runtime tmux functions
source "${_DEV_ROOT}/lib/tmux.sh"

# Change into project directory
cd "$WORKSPACE/$project"

# Create tmux session
new_session=false

if initialize_session "$name"; then
  new_session=true

  # Store the project in the session's environment for future conflict detection
  tmux set-environment -t "$name" DEV_PROJECT "$project"

  session_file="$WORKSPACE/$project/.config/dev-session"
  if [ -f "$session_file" ]; then
    source "$session_file"
  else
    default_windows
    select_window 3
  fi

  finalize
fi

switch_to_session "$name"

# Show loading screen only for new sessions
if $new_session && command -v tarts &>/dev/null; then
  dev tmux loading-screen
fi
