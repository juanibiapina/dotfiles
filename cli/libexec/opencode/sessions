#!/usr/bin/env bash
#
# Summary: List opencode sessions for the current day
#
# Usage: {cmd}
#
# Lists all opencode sessions from today, grouped by project.
# Shows session ID and title for each session.

set -e

STORAGE_DIR="$HOME/.local/share/opencode/storage"
SESSION_DIR="$STORAGE_DIR/session"
PROJECT_DIR="$STORAGE_DIR/project"

# Get today's date boundaries in milliseconds
TODAY_START=$(($(date -j -f "%Y-%m-%d %H:%M:%S" "$(date +%Y-%m-%d) 00:00:00" +%s) * 1000))
TODAY_END=$(($(date -j -f "%Y-%m-%d %H:%M:%S" "$(date -v+1d +%Y-%m-%d) 00:00:00" +%s) * 1000))

# Build project hash to name mapping
declare -A project_names
for project_file in "$PROJECT_DIR"/*.json; do
  [[ -f "$project_file" ]] || continue
  hash=$(basename "$project_file" .json)
  worktree=$(jq -r '.worktree // "unknown"' "$project_file")
  # Extract short name from path
  name=$(echo "$worktree" | sed 's|.*/||')
  project_names[$hash]="$name|$worktree"
done

# Collect sessions by project
declare -A sessions_by_project

for project_hash_dir in "$SESSION_DIR"/*/; do
  [[ -d "$project_hash_dir" ]] || continue
  project_hash=$(basename "$project_hash_dir")
  
  for session_file in "$project_hash_dir"*.json; do
    [[ -f "$session_file" ]] || continue
    
    # Check session updated time from JSON (in milliseconds)
    session_updated=$(jq -r '.time.updated // 0' "$session_file")
    if [[ $session_updated -ge $TODAY_START && $session_updated -lt $TODAY_END ]]; then
      session_id=$(jq -r '.id' "$session_file")
      title=$(jq -r '.title // "Untitled"' "$session_file")
      
      # Skip subagent sessions
      [[ "$title" == *"subagent"* ]] && continue
      
      # Add to project's sessions
      if [[ -n "${sessions_by_project[$project_hash]}" ]]; then
        sessions_by_project[$project_hash]+=$'\n'"$session_id|$title"
      else
        sessions_by_project[$project_hash]="$session_id|$title"
      fi
    fi
  done
done

# Output grouped by project
total=0
for project_hash in "${!sessions_by_project[@]}"; do
  project_info="${project_names[$project_hash]:-unknown|unknown}"
  project_name="${project_info%%|*}"
  project_path="${project_info#*|}"
  
  echo ""
  echo "[$project_name] $project_path"
  echo ""
  
  while IFS='|' read -r session_id title; do
    echo "  $session_id  $title"
    total=$((total + 1))
  done <<< "${sessions_by_project[$project_hash]}"
done

echo ""
echo "Total: $total sessions today"
