#!/usr/bin/env bash
#
# Summary: Switch NixOS to new config
#
# Usage: {cmd} [--reboot] [rest]...
# Options:
#   reboot: Reboot after switching to new config
#
# Automatically detects the platform and uses the appropriate command:
# - macOS: darwin-rebuild
# - Linux: nixos-rebuild

set -e

source "${_DEV_ROOT}/lib/gum.sh"

declare -A args="($_DEV_ARGS)"

# Determine flake target (check for override file, fallback to default)
NIX_HOST_FILE="$DOTFILES_HOME/.nix-host"
if [ -f "$NIX_HOST_FILE" ]; then
  NIX_HOST=$(cat "$NIX_HOST_FILE")
  FLAKE_TARGET="$DOTFILES_HOME#$NIX_HOST"
else
  FLAKE_TARGET="$DOTFILES_HOME"
fi

# switch system
if [ "$(uname -s)" = "Darwin" ]; then
  header "Updating Homebrew..."
  brew update

  header "Switching to new configuration..."
  sudo darwin-rebuild switch --flake $FLAKE_TARGET ${args[rest]}
else
  header "Switching to new configuration..."
  sudo nixos-rebuild switch ${args[rest]}

  # restart home manager service
  # this is needed to relink dotfiles that may have been changed manually
  sudo systemctl restart home-manager-juan.service
fi

# reboot if requested
if [[ "${args[reboot]}" == "true" ]]; then
  dev send-notification 0 "Rebooting in 10 seconds" now

  sleep 10

  sudo reboot -h now
fi

# reboot if necessary (only for NixOS hosts)
if [ "$(uname -s)" != "Darwin" ]; then
  booted="$(readlink /run/booted-system/{initrd,kernel,kernel-modules})"
  built="$(readlink /nix/var/nix/profiles/system/{initrd,kernel,kernel-modules})"

  if [ "''${booted}" != "''${built}" ]; then
    warning "Rebooting because of kernel change"
    dev send-notification 0 "Rebooting in 10 seconds because of a Kernel change" now

    sleep 10

    sudo reboot -h now
  fi
fi

success
