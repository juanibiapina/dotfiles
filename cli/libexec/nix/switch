#!/usr/bin/env bash
#
# Summary: Switch NixOS to new config
#
# Usage: {cmd} [--reboot]
# Options:
#   --reboot Reboot after switching to new config

set -e

# parse command line arguments
source "${_DEV_ROOT}/lib/argparse.bash"
parse_args '' reboot "$@"
reboot="$(arg "--reboot")"

# switch system
if [ "$(uname -s)" = "Darwin" ]; then
  darwin-rebuild switch --flake $DOTFILES_HOME
else
  sudo nixos-rebuild switch
fi

# reboot if requested
if [ "$reboot" = true ]; then
  dev send-notification 0 "Rebooting in 10 seconds" now

  sleep 10

  sudo reboot -h now
fi
